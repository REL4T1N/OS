# Лабораторная работа №4: Динамические библиотеки

## Описание

Лабораторная работа посвящена изучению работы с динамическими библиотеками в языке C. Реализованы два способа использования библиотек: статическая линковка на этапе компиляции и динамическая загрузка во время выполнения программы.

## Структура проекта

```
lab4/
├── include/
│   └── lib_contract.h        # Заголовочный файл с контрактами функций
├── src/
│   ├── lib1/                 # Реализация 1 (прямоугольники + Евклид)
│   │   ├── sin_integral.c
│   │   └── gcf.c
│   ├── lib2/                 # Реализация 2 (трапеции + наивный алгоритм)
│   │   ├── sin_integral.c
│   │   └── gcf.c
│   ├── prog1/                # Программа со статической линковкой
│   │   ├── main.c
│   │   └── Makefile
│   └── prog2/                # Программа с динамической загрузкой
│       ├── main.c
│       └── Makefile
├── build/                    # Директория для собранных файлов
├── Makefile                  # Основной Makefile
└── README.md                 # Этот файл
```

## Функциональность

### Библиотеки реализуют следующие функции:

1. **`float sinIntegral(float A, float B, float e)`** - вычисление интеграла sin(x) на отрезке [A, B] с шагом e
   - `lib1`: метод прямоугольников
   - `lib2`: метод трапеций

2. **`int GCF(int A, int B)`** - вычисление наибольшего общего делителя
   - `lib1`: алгоритм Евклида
   - `lib2`: наивный алгоритм (перебор)

### Программы:

1. **`program1`** - использует библиотеку lib1 через статическую линковку
2. **`program2`** - загружает библиотеки динамически с возможностью переключения

## Сборка и запуск

### Сборка всего проекта:
```bash
make clean-all
make all
```

### Запуск program1 (статическая линковка):
```bash
make run1
# или
LD_LIBRARY_PATH=build/lib ./build/program1
```

### Запуск program2 (динамическая загрузка):
```bash
make run2
# или
LD_LIBRARY_PATH=build/lib ./build/program2
```

### Быстрый тест:
```bash
make test
```

### Запуск с трассировкой системных вызовов:
```bash
make strace-test1  # для program1
make strace-test2  # для program2
```

## Использование

### Команды для обеих программ:

1. **`1 A B e`** - вычислить интеграл sin(x) от A до B с шагом e
   ```
   > 1 0 3.14159 0.1
   Result (Rectangles method): 1.997120
   ```

2. **`2 A B`** - найти НОД чисел A и B
   ```
   > 2 48 18
   Result (Euclidean algorithm): 6
   ```

3. **`3`** - выход из программы

### Особенность program2:
- **`0`** - переключение между библиотеками lib1 и lib2
  ```
  [lib1]> 0
  Switched to lib2.so
  ```

# Выводы

Данная лабораторная работа посвящена изучению динамических библиотек в операционных системах. Цель работы — приобретение практических навыков работы с двумя основными подходами к использованию библиотек: статической линковкой на этапе компиляции и динамической загрузкой во время выполнения программы.

## Что я узнал из этой работы

### 1. **Принципиальные различия между статической и динамической линковкой**
- При **статической линковке** библиотека становится частью исполняемого файла, что упрощает распространение программы, но увеличивает её размер
- **Динамическая загрузка** позволяет загружать библиотеки по требованию, что экономит память и позволяет реализовать гибкие архитектуры (плагины, модули)

### 2. **API динамической загрузки (`<dlfcn.h>`)**
Я освоил использование функций:
- `dlopen()` — для загрузки библиотеки в память
- `dlsym()` — для получения указателей на функции
- `dlclose()` — для выгрузки библиотеки
- `dlerror()` — для обработки ошибок

## Трудности, с которыми я столкнулся

### 1. **Проблемы с путями к библиотекам**
Первоначально программа не могла найти библиотеки, потому что:
- Неправильно был указан `rpath`
- Относительные пути работали только при запуске из определённой директории
- Пришлось разобраться с макросом `$ORIGIN` для указания путей относительно исполняемого файла

### 2. **Обработка ошибок**
Особое внимание потребовалось:
- Правильной последовательности вызовов `dlerror()` (сначала сброс, потом проверка)
- Проверке всех возвращаемых значений функций `dl*`
- Обработке крайних случаев в математических функциях (деление на ноль, переполнение)

## Ценность полученных знаний

Полученные навыки позволяют:
- Создавать модульные программы с поддержкой плагинов
- Реализовывать "горячее" обновление частей системы без перезапуска
- Оптимизировать использование памяти в больших приложениях
- Правильно организовывать проект, разделяя его на логические библиотеки

---
*Лабораторная работа выполнена в рамках курса "Операционные системы"*