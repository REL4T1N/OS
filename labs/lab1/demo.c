#include <stdio.h>
#include <unistd.h>
#include <sys/wait.h>
#include <string.h>

int main() {
    // Pipe - —ç—Ç–æ —Ç—Ä—É–±–∫–∞ –º–µ–∂–¥—É –¥–≤—É–º—è –∫–æ–º–Ω–∞—Ç–∞–º–∏
    int pipefd[2];  // –ú–∞—Å—Å–∏–≤ –¥–ª—è pipe: [0] - —á—Ç–µ–Ω–∏–µ, [1] - –∑–∞–ø–∏—Å—å
    // pipefd[0] - –∫–æ–Ω–µ—Ü –¥–ª—è –ß–¢–ï–ù–ò–Ø (—É—à–∫–æ, —á—Ç–æ–±—ã —Å–ª—É—à–∞—Ç—å)
    // pipefd[1] - –∫–æ–Ω–µ—Ü –¥–ª—è –ó–ê–ü–ò–°–ò (—Ä—É–ø–æ—Ä, —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å)
    pid_t pid;
    char buffer[100];
    
    printf("=== –î–ï–ú–û –°–ò–°–¢–ï–ú–ù–´–• –í–´–ó–û–í–û–í ===\n\n");
    
    // 1. –°–û–ó–î–ê–ï–ú PIPE (—Ç—Ä—É–±–∫—É –¥–ª—è –æ–±—â–µ–Ω–∏—è)
    printf("1. –°–æ–∑–¥–∞–µ–º pipe (—Ç—Ä—É–±–∫—É) –¥–ª—è –æ–±—â–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...\n");
    // pipe(...) - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä—É–±–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤, –≥–¥–µ 0 —ç–ª–µ–º–µ–Ω—Ç - —á—Ç–µ–Ω–∏–µ –∏–∑ —Ç—Ä—É–±–∫—Ç, 1 —ç–ª–µ–º–µ–Ω—Ç - –∑–∞–ø–∏—Å—å –≤ —Ç—Ä—É–±–∫—É
    // –≤ pipefd[0] –∑–∞–ø–∏—Å–∞–Ω —Ñ–∞–π–ª–æ–≤—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä
    // –≤ pipefd[1] –∑–∞–ø–∏—Å–∞–Ω —Ñ–∞–π–ª–æ–≤—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä
    // –§–∞–π–ª–æ–≤—ã–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã - —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Å–∏—Å—Ç–µ–º–µ.
    if (pipe(pipefd) == -1) {
        perror("pipe failed");
        return 1;
    }
    printf("   pipefd[0] = %d (—á—Ç–µ–Ω–∏–µ), pipefd[1] = %d (–∑–∞–ø–∏—Å—å)\n\n", pipefd[0], pipefd[1]);
    
    // 2. –°–û–ó–î–ê–ï–ú –î–û–ß–ï–†–ù–ò–ô –ü–†–û–¶–ï–°–° (fork)
    // –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å - —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞
    // fork() - —Å–æ–∑–¥–∞–µ—Ç —Ç–æ—á–Ω—É—é –∫–æ–ø–∏—é –∫–æ–º–Ω–∞—Ç—ã
    printf("2. –°–æ–∑–¥–∞–µ–º –¥–æ—á–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å (fork)...\n");
    pid = fork();
    
    if (pid == -1) {
        perror("fork failed");
        return 1;
    }
    
    if (pid == 0) {
        // –î–û–ß–ï–†–ù–ò–ô –ü–†–û–¶–ï–°–° (—Ä–µ–±–µ–Ω–æ–∫)
        // –≠—Ç–æ –ö–û–ü–ò–Ø –∫–æ–º–Ω–∞—Ç—ã (–¥–æ—á–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å)
        printf("   üë∂ –î–û–ß–ï–†–ù–ò–ô –ü–†–û–¶–ï–°–°: –ú–æ–π PID = %d, –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π PID = %d\n", getpid(), getppid());
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω–µ—Ü –¥–ª—è —á—Ç–µ–Ω–∏—è (—Ä–µ–±–µ–Ω–æ–∫ —Ç–æ–ª—å–∫–æ –ø–∏—à–µ—Ç)
        close(pipefd[0]);
        
        // –ü–∏—à–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ pipe
        char message[] = "–ü—Ä–∏–≤–µ—Ç –æ—Ç —Ä–µ–±–µ–Ω–∫–∞!";
        printf("   üë∂ –ü–∏—à–µ–º –≤ pipe: '%s'\n", message);
        write(pipefd[1], message, strlen(message) + 1);
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω–µ—Ü –¥–ª—è –∑–∞–ø–∏—Å–∏
        close(pipefd[1]);
        printf("   üë∂ –î–æ—á–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è\n");
        
    } else {
        // –†–û–î–ò–¢–ï–õ–¨–°–ö–ò–ô –ü–†–û–¶–ï–°–° (—Ä–æ–¥–∏—Ç–µ–ª—å)
        printf("   üë® –†–û–î–ò–¢–ï–õ–¨–°–ö–ò–ô –ü–†–û–¶–ï–°–°: –ú–æ–π PID = %d, –î–æ—á–µ—Ä–Ω–∏–π PID = %d\n", getpid(), pid);
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω–µ—Ü –¥–ª—è –∑–∞–ø–∏—Å–∏ (—Ä–æ–¥–∏—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ—Ç)
        close(pipefd[1]);
        
        // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã —Ä–µ–±–µ–Ω–æ–∫ —É—Å–ø–µ–ª –∑–∞–ø–∏—Å–∞—Ç—å
        sleep(1);
        
        // –ß–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ pipe
        printf("   üë® –ß–∏—Ç–∞–µ–º –∏–∑ pipe...\n");
        int bytes_read = read(pipefd[0], buffer, sizeof(buffer));
        
        if (bytes_read > 0) {
            printf("   üë® –ü–æ–ª—É—á–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ: '%s'\n", buffer);
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω–µ—Ü –¥–ª—è —á—Ç–µ–Ω–∏—è
        close(pipefd[0]);
        
        // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ—á–µ—Ä–Ω–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
        wait(NULL);
        printf("   üë® –î–æ—á–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–∫–æ–Ω—á–µ–Ω–∞.\n");
    }
    
    return 0;
}